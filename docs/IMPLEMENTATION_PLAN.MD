# ClearTask Implementation Plan (v1.0)

## 1. Unified Task Schema
This schema serves as the single source of truth across the Database, API, and Frontend.

| Field | Type | SQL Constraint | Layer Logic |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Generated by Backend. |
| `user_id` | STRING | NOT NULL | Links to Google OAuth ID. |
| `task_name` | TEXT | NOT NULL | Parsed by LLM. |
| `due_date` | DATE | NULL | Normalized YYYY-MM-DD. |
| `is_completed`| BOOLEAN | DEFAULT FALSE | Completion status. |
| `original_request`| TEXT | NOT NULL | Raw transcript for debugging. |

---

## 2. Phase 1: Docker Foundation & Authentication
**Goal:** Establish a secure, containerized environment with "Fail Loudly" sync infrastructure.

### 2.1 Infrastructure (Local Only)
* Set up `docker-compose.yml` with three containers: `frontend` (React/Vite), `backend` (Fastify), and `db` (Postgres).
* Initialize **IndexedDB** on the frontend for local caching to ensure users never have to re-record tasks if offline.

### 2.2 Authentication
* Implement **Google OAuth 2.0** using a full-page redirect flow to ensure compatibility with zoom tools.
* Use `fastify-jwt` for session persistence so users remain logged in across sessions.

### 2.3 TDD Strategy
* **Test:** Verify that `GET /api/tasks` returns `401 Unauthorized` without a valid token.
* **Test:** Verify that a new task saved to IndexedDB is successfully moved to the Postgres DB when the browser `online` event triggers.

---

## 3. Phase 2: DB Setup & Priority Display
**Goal:** Implement the "Tiered Priority" UI and the "Nulls First" sorting logic.

### 3.1 Backend Sorting Logic
* Implement the chronological sort that forces tasks without dates to the top:
  ~~~~sql
  SELECT * FROM tasks 
  WHERE user_id = 'current_user' AND is_completed = false 
  ORDER BY due_date ASC NULLS FIRST;
  ~~~~

### 3.2 Frontend UI (Accessibility-First)
* Render task cards with **Atkinson Hyperlegible** font and **80px touch targets**.
* Apply an **Electric Yellow** border to Tier 1 tasks (those with `due_date = NULL`).

### 3.3 TDD Strategy
* **Test:** Seed the database with tasks due "Tomorrow" and tasks with "No Date." Verify the "No Date" tasks appear at the top of the array returned by the API.

---

## 4. Phase 3: Task Creation (The Voice Loop)
**Goal:** Implement the resilient Intelligence Layer and standard audio scripts.

### 4.1 Hardware Permission Strategy
* Use the manual microphone toggle tap to "unlock" the browser's **AudioContext** for TTS.
* Trigger `navigator.vibrate` and the different "Start/Stop" audio blips on toggle.

### 4.2 Intelligence & Resiliency
* Implement the **Requesty** primary call with a **3-second timeout**.
* Configure the failover to call the **OpenAI API** directly if Requesty fails.
* Standardize TTS scripts for "Creation" and "Ambiguity" scenarios.

### 4.3 TDD Strategy
* **Test:** Mock a Requesty timeout and verify the system retries with OpenAI.
* **Test:** Verify that if the LLM returns `is_ambiguous: true`, the system speaks the specific `clarification_prompt`.

---

## 5. Phase 4: Deletion (Confirmation State Machine)
**Goal:** Implement safe, voice-gated destructive actions.

### 5.1 Confirmation Logic
1. User requests deletion via voice.
2. Frontend sets the task to "Pending Deletion" and highlights it in **Electric Yellow**.
3. The rest of the UI is "locked" to prevent accidental taps.
4. App speaks: “Are you sure you want to delete [Task]?” and opens the mic for **10 seconds**.

### 5.2 TDD Strategy
* **Test:** Verify that if the user says "No" or the 10-second timer expires, the task returns to its normal state and the UI unlocks.

---

## 6. Phase 5: Natural Language Editing
**Goal:** Allow users to update tasks via casual speech (e.g., "Change milk to Saturday").

### 6.1 Logic
* Refine the System Prompt to identify editing intent and match transcripts to existing database entries.
* Implement the reversible archive toggle that moves completed tasks without shifting the layout.

### 6.2 TDD Strategy
* **Test:** Send a transcript "Mark milk as done" and verify the `is_completed` flag is toggled to `true`.